<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 試算表 BOM 比較工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .table-cell {
            padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            white-space: nowrap;
        }
        .table-header {
            position: sticky;
            top: 0;
            background-color: #F9FAFB; /* gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">BOM 內容比較工具</h1>
            <p class="text-gray-600 mt-2">請貼上從 Google 試算表「發佈到網路」產生的 CSV 連結</p>
        </header>

        <!-- 輸入區 -->
        <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="url" id="sheet-url" placeholder="在此貼上您的 .csv 連結" class="w-full px-4 py-2 bg-white text-gray-900 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="compare-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                    開始比較
                </button>
            </div>
        </div>

        <!-- 狀態與結果顯示區 -->
        <div id="status" class="text-center my-6 text-lg text-yellow-600"></div>

        <div id="results-container" class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 共同項目 -->
            <div id="common-items" class="bg-white p-6 rounded-lg shadow-md hidden"></div>
            <!-- BOM1 獨有 -->
            <div id="bom1-only-items" class="bg-white p-6 rounded-lg shadow-md hidden"></div>
            <!-- BOM2 獨有 -->
            <div id="bom2-only-items" class="bg-white p-6 rounded-lg shadow-md hidden"></div>
        </div>
    </div>

    <script>
        // 監聽按鈕點擊事件
        document.getElementById('compare-btn').addEventListener('click', handleCompare);

        // 主要處理函式
        async function handleCompare() {
            const urlInput = document.getElementById('sheet-url');
            const url = urlInput.value.trim();
            const statusDiv = document.getElementById('status');
            const resultsContainer = document.getElementById('results-container');

            // 清空舊的結果和狀態
            statusDiv.textContent = '';
            document.getElementById('common-items').innerHTML = '';
            document.getElementById('bom1-only-items').innerHTML = '';
            document.getElementById('bom2-only-items').innerHTML = '';
            document.getElementById('common-items').classList.add('hidden');
            document.getElementById('bom1-only-items').classList.add('hidden');
            document.getElementById('bom2-only-items').classList.add('hidden');


            if (!url) {
                statusDiv.textContent = '錯誤：請先輸入 Google Sheet 的 CSV 連結。';
                statusDiv.className = 'text-center my-6 text-lg text-red-600';
                return;
            }

            statusDiv.textContent = '正在從 Google Sheet 讀取資料...';
            statusDiv.className = 'text-center my-6 text-lg text-blue-600';

            try {
                // 使用 fetch 取得 CSV 資料
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`網路錯誤: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();

                statusDiv.textContent = '資料讀取完畢，正在進行分析...';
                
                // 解析並比較 BOM
                parseAndCompareBOMs(csvText);

                statusDiv.textContent = '比較完成！';
                statusDiv.className = 'text-center my-6 text-lg text-green-600';

            } catch (error) {
                console.error('處理時發生錯誤:', error);
                statusDiv.textContent = `發生錯誤：${error.message}。請檢查連結是否正確，或開啟瀏覽器開發者工具(F12)查看詳細資訊。`;
                statusDiv.className = 'text-center my-6 text-lg text-red-600';
            }
        }

        // 解析 CSV 並比較 BOM
        function parseAndCompareBOMs(csvText) {
            const rows = csvText.split('\n').map(row => row.trim().split(','));

            // 預期 A2, B2, C2, D2 是 BOM1 的標頭
            // 預期 F2, G2, H2, I2 是 BOM2 的標頭 (注意:CSV中 E1 會是第4個欄位)
            // BOM1: 欄位 0, 1, 2, 3
            // BOM2: 欄位 4, 5, 6, 7 (因為 E1 在 CSV 中是第 5 個欄位)

            const bom1Items = [];
            const bom2Items = [];

            // 從第三行開始讀取資料 (索引為 2)
            for (let i = 2; i < rows.length; i++) {
                const row = rows[i];
                
                // 處理 BOM 1 (A, B, C, D 欄)
                const bom1Title = row[0] || '';
                const bom1Spec = row[1] || '';
                if (bom1Title || bom1Spec) { // 至少要有標題或規格才算一筆資料
                    bom1Items.push({
                        title: bom1Title,
                        spec: bom1Spec,
                        vendor: row[2] || '',
                        quantity: row[3] || ''
                    });
                }

                // 處理 BOM 2 (E, F, G, H 欄)
                const bom2Title = row[4] || '';
                const bom2Spec = row[5] || '';
                 if (bom2Title || bom2Spec) {
                    bom2Items.push({
                        title: bom2Title,
                        spec: bom2Spec,
                        vendor: row[6] || '',
                        quantity: row[7] || ''
                    });
                }
            }

            // 使用 "標題+規格" 作為唯一鍵來比較
            const createKey = (item) => `${item.title}::${item.spec}`;

            const bom1Keys = new Set(bom1Items.map(createKey));
            const bom2Keys = new Set(bom2Items.map(createKey));

            // 找出共同、獨有項目
            const commonItems = bom1Items.filter(item => bom2Keys.has(createKey(item)));
            const bom1OnlyItems = bom1Items.filter(item => !bom2Keys.has(createKey(item)));
            const bom2OnlyItems = bom2Items.filter(item => !bom1Keys.has(createKey(item)));

            // 渲染結果到畫面上
            renderTable('common-items', '共同項目', commonItems, ['#16a34a', '#15803d']); // 綠色
            renderTable('bom1-only-items', '僅 BOM 1 擁有', bom1OnlyItems, ['#ea580c', '#c2410c']); // 橘色
            renderTable('bom2-only-items', '僅 BOM 2 擁有', bom2OnlyItems, ['#2563eb', '#1d4ed8']); // 藍色
        }

        // 渲染表格的輔助函式
        function renderTable(elementId, title, items, colors) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.classList.remove('hidden');

            let html = `
                <h2 class="text-2xl font-bold mb-4 text-center" style="color: ${colors[0]};">
                    ${title} (${items.length})
                </h2>
                <div class="overflow-x-auto max-h-96 border border-gray-200 rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-600 uppercase table-header">
                            <tr>
                                <th scope="col" class="table-cell">標題</th>
                                <th scope="col" class="table-cell">規格</th>
                                <th scope="col" class="table-cell">廠商</th>
                                <th scope="col" class="table-cell">數量</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
            `;

            if (items.length === 0) {
                html += `<tr><td colspan="4" class="text-center py-4 text-gray-500">無項目</td></tr>`;
            } else {
                items.forEach(item => {
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell text-gray-900">${item.title}</td>
                            <td class="table-cell text-gray-900">${item.spec}</td>
                            <td class="table-cell text-gray-900">${item.vendor}</td>
                            <td class="table-cell text-gray-900">${item.quantity}</td>
                        </tr>
                    `;
                });
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }
    </script>
</body>
</html>
